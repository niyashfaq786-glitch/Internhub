import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getAuth,
  signOut,
  createUserWithEmailAndPassword
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import {
  getFirestore,
  doc,
  setDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ✅ IMPORTANT: Secondary app/auth for creating accounts (don’t disturb admin login)
const secondaryApp = initializeApp(firebaseConfig, "SECONDARY");
const secondaryAuth = getAuth(secondaryApp);

function normalizeStudentId(v) {
  return String(v || "").trim().toUpperCase(); // S101
}
function buildStudentEmail(studentId) {
  return `${studentId.toLowerCase()}@internhub.com`;
}

function toISODate(v) {
  // supports YYYY-MM-DD or DD/MM/YYYY
  const s = String(v || "").trim();
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

  const m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
  if (m) return `${m[3]}-${m[2]}-${m[1]}`;
  return ""; // invalid
}

async function createStudentAccount(row, adminCtx) {
  const student_id = normalizeStudentId(row.student_id);
  const email = buildStudentEmail(student_id);
  const password = String(row.password || "").trim();

  const valid_from = toISODate(row.valid_from);
  const valid_to   = toISODate(row.valid_to);

  if (!student_id) throw new Error("Missing student_id");
  if (password.length < 6) throw new Error("Password must be 6+ chars");
  if (!valid_from || !valid_to) throw new Error("Invalid date format (use YYYY-MM-DD or DD/MM/YYYY)");

  // ✅ 1) Create Auth user
  const cred = await createUserWithEmailAndPassword(secondaryAuth, email, password);

  // ✅ 2) Save Firestore profile using student_id as doc id (BEST)
  await setDoc(doc(db, "students", student_id), {
    student_id,
    name: row.name || "",
    email,
    branch: row.branch || "",
    college: row.college || "",
    college_id: row.college_id || adminCtx.college_id || "",
    status: "ACTIVE",
    valid_from,
    valid_to,
    created_at: serverTimestamp(),
    created_by_admin: adminCtx.admin_id || ""
  }, { merge: true });

  // ✅ 3) signout secondary (important)
  await signOut(secondaryAuth);

  return cred.user.uid;
}
